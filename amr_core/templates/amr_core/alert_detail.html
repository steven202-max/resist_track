{% extends 'amr_core/base.html' %}

{% block title %}Alert Detail - {{ alert.title }} - AMR Tracking System{% endblock %}
{% block page_title %}Alert Detail{% endblock %}

{% block content %}
<div class="row">
    <!-- Alert Information -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center
                {% if alert.priority == 'critical' %}bg-danger text-white
                {% elif alert.priority == 'high' %}bg-warning text-dark
                {% elif alert.priority == 'medium' %}bg-info text-white
                {% else %}bg-secondary text-white{% endif %}">
                <h5 class="mb-0">
                    {% if alert.priority == 'critical' %}
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    {% elif alert.priority == 'high' %}
                        <i class="bi bi-exclamation-triangle"></i>
                    {% else %}
                        <i class="bi bi-info-circle"></i>
                    {% endif %}
                    {{ alert.title }}
                </h5>
                <div>
                    <span class="badge bg-light text-dark me-2">{{ alert.get_priority_display }}</span>
                    <span class="badge 
                        {% if alert.status == 'active' %}bg-danger
                        {% elif alert.status == 'acknowledged' %}bg-warning
                        {% elif alert.status == 'resolved' %}bg-success
                        {% else %}bg-secondary{% endif %}">
                        {{ alert.get_status_display }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <!-- Alert Details -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="bi bi-person"></i> Patient Information</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td><strong>Patient:</strong></td>
                                <td>
                                    <a href="{% url 'patient_dashboard' alert.patient.id %}" class="text-decoration-none">
                                        {{ alert.patient.name }}
                                    </a>
                                    <span class="badge bg-primary ms-2">{{ alert.patient.id }}</span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Age:</strong></td>
                                <td>{{ alert.patient.age }} years</td>
                            </tr>
                            <tr>
                                <td><strong>Gender:</strong></td>
                                <td>{{ alert.patient.get_gender_display }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-prescription"></i> Treatment Information</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td><strong>Antibiotic:</strong></td>
                                <td>{{ alert.prescription.antibiotic.name }}</td>
                            </tr>
                            <tr>
                                <td><strong>Diagnosis:</strong></td>
                                <td>{{ alert.prescription.diagnosis }}</td>
                            </tr>
                            <tr>
                                <td><strong>Dosage:</strong></td>
                                <td>{{ alert.prescription.dosage }} {{ alert.prescription.frequency }}</td>
                            </tr>
                            <tr>
                                <td><strong>Started:</strong></td>
                                <td>{{ alert.prescription.date_prescribed|date:"M d, Y" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Alert Description -->
                <div class="mb-4">
                    <h6><i class="bi bi-chat-square-text"></i> Alert Description</h6>
                    <div class="alert alert-info">
                        {{ alert.description }}
                    </div>
                </div>

                <!-- Trigger Information -->
                <div class="mb-4">
                    <h6><i class="bi bi-lightning"></i> Trigger Information</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Alert Type:</strong> {{ alert.get_alert_type_display }}</p>
                            <p><strong>Triggered By:</strong> {{ alert.triggered_by }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Created:</strong> {{ alert.created_date|date:"M d, Y H:i" }}</p>
                            {% if alert.acknowledged_date %}
                            <p><strong>Acknowledged:</strong> {{ alert.acknowledged_date|date:"M d, Y H:i" }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Status and Actions -->
                {% if alert.status == 'active' %}
                <div class="mb-4">
                    <h6><i class="bi bi-tools"></i> Actions</h6>
                    <div class="d-flex gap-2">
                        <form method="post" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="acknowledge">
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-check-circle"></i> Acknowledge Alert
                            </button>
                        </form>
                        
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#resolveModal">
                            <i class="bi bi-check2-all"></i> Resolve Alert
                        </button>
                        
                        <a href="{% url 'patient_assessment_with_prescription' alert.patient.id alert.prescription.id %}" class="btn btn-info">
                            <i class="bi bi-clipboard-pulse"></i> Conduct Assessment
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- Doctor Actions and Resolution Notes -->
                {% if alert.doctor_actions or alert.resolution_notes %}
                <div class="mb-4">
                    <h6><i class="bi bi-journal-medical"></i> Doctor Actions & Resolution</h6>
                    {% if alert.doctor_actions %}
                    <div class="mb-3">
                        <strong>Actions Taken:</strong>
                        <div class="alert alert-success">{{ alert.doctor_actions }}</div>
                    </div>
                    {% endif %}
                    
                    {% if alert.resolution_notes %}
                    <div class="mb-3">
                        <strong>Resolution Notes:</strong>
                        <div class="alert alert-info">{{ alert.resolution_notes }}</div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Alert Status Card -->
        <div class="card mb-4">
            <div class="card-header bg-hospital-primary text-white">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i> Alert Status
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <div class="fw-bold 
                                {% if alert.priority == 'critical' %}text-danger
                                {% elif alert.priority == 'high' %}text-warning
                                {% elif alert.priority == 'medium' %}text-info
                                {% else %}text-secondary{% endif %}">
                                {{ alert.get_priority_display }}
                            </div>
                            <small class="text-muted">Priority</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <div class="fw-bold 
                                {% if alert.status == 'active' %}text-danger
                                {% elif alert.status == 'acknowledged' %}text-warning
                                {% elif alert.status == 'resolved' %}text-success
                                {% else %}text-secondary{% endif %}">
                                {{ alert.get_status_display }}
                            </div>
                            <small class="text-muted">Status</small>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="small text-muted">
                    <p><strong>Created:</strong> {{ alert.created_date|date:"M d, Y H:i" }}</p>
                    {% if alert.acknowledged_by %}
                    <p><strong>Acknowledged by:</strong> {{ alert.acknowledged_by }}</p>
                    {% endif %}
                    {% if alert.acknowledged_date %}
                    <p><strong>Acknowledged:</strong> {{ alert.acknowledged_date|date:"M d, Y H:i" }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recommended Alternatives -->
        {% if alert.recommended_alternatives.exists %}
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                    <i class="bi bi-arrow-repeat"></i> Recommended Alternatives
                </h6>
            </div>
            <div class="card-body">
                {% for alternative in alert.recommended_alternatives.all %}
                <div class="border rounded p-2 mb-2">
                    <strong>{{ alternative.name }}</strong>
                    <br>
                    <small class="text-muted">{{ alternative.class_type }}</small>
                </div>
                {% endfor %}
                
                {% if alert.alternative_reasoning %}
                <div class="mt-3">
                    <strong>Reasoning:</strong>
                    <p class="small text-muted">{{ alert.alternative_reasoning }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header bg-hospital-light-blue">
                <h6 class="mb-0 text-hospital-primary">
                    <i class="bi bi-lightning"></i> Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'patient_dashboard' alert.patient.id %}" class="btn btn-outline-hospital-primary btn-sm">
                        <i class="bi bi-person"></i> Patient Dashboard
                    </a>
                    <a href="{% url 'patient_assessment_with_prescription' alert.patient.id alert.prescription.id %}" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-clipboard-pulse"></i> New Assessment
                    </a>
                    <a href="{% url 'prescription_success' alert.prescription.id %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-prescription"></i> View Prescription
                    </a>
                    <a href="{% url 'medicine_alerts' %}" class="btn btn-outline-warning btn-sm">
                        <i class="bi bi-arrow-left"></i> Back to Alerts
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resolve Alert Modal -->
<div class="modal fade" id="resolveModal" tabindex="-1" aria-labelledby="resolveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="resolve">
                <div class="modal-header">
                    <h5 class="modal-title" id="resolveModalLabel">Resolve Alert</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="resolution_notes" class="form-label">Resolution Notes</label>
                        <textarea class="form-control" id="resolution_notes" name="resolution_notes" rows="4" 
                                  placeholder="Describe how this alert was resolved and any actions taken..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check2-all"></i> Resolve Alert
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
