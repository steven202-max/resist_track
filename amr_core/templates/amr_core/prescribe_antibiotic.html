{% extends 'amr_core/base.html' %}

{% block title %}Prescribe Antibiotic - AMR Tracking System{% endblock %}
{% block page_title %}New Prescription{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header bg-hospital-primary text-white">
                <h4 class="mb-0">
                    <i class="bi bi-prescription"></i> Prescribe Antibiotic
                </h4>
                <p class="mb-0 mt-2 opacity-75">Smart prescribing with real-time resistance checking</p>
            </div>
            <div class="card-body p-4">
                <form method="post" id="prescriptionForm">
                    {% csrf_token %}
                    
                    <!-- Patient Selection -->
                    <div class="row mb-4">
                        <div class="col-lg-12">
                            <label for="{{ form.patient.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-person-heart text-hospital-primary"></i> Select Patient
                            </label>
                            {{ form.patient }}
                            <div class="form-text">Choose the patient for this prescription.</div>
                        </div>
                    </div>

                    <!-- Antibiotic Selection -->
                    <div class="row mb-4">
                        <div class="col-lg-12">
                            <label for="{{ form.antibiotic.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-capsule text-hospital-primary"></i> Select Antibiotic
                            </label>
                            {{ form.antibiotic }}
                            <div class="form-text">Choose the antibiotic to prescribe.</div>
                        </div>
                    </div>

                    <!-- Resistance Check Alert -->
                    <div id="resistanceAlert" class="alert alert-hospital-danger d-none" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                            <div>
                                <h6 class="alert-heading mb-1">⚠️ Resistance Detected!</h6>
                                <span id="resistanceMessage"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Diagnosis -->
                    <div class="row mb-4">
                        <div class="col-lg-12">
                            <label for="{{ form.diagnosis.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-clipboard-pulse text-hospital-primary"></i> Diagnosis
                            </label>
                            {{ form.diagnosis }}
                            <div class="form-text">Enter the diagnosis and condition details.</div>
                        </div>
                    </div>

                    <!-- Prescription Details -->
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.dosage.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-droplet text-hospital-primary"></i> Dosage
                            </label>
                            {{ form.dosage }}
                            <div class="form-text">e.g., 500mg</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.frequency.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-clock text-hospital-primary"></i> Frequency
                            </label>
                            {{ form.frequency }}
                            <div class="form-text">e.g., Twice daily</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.duration.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-calendar text-hospital-primary"></i> Duration
                            </label>
                            {{ form.duration }}
                            <div class="form-text">e.g., 7 days</div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="row mb-4">
                        <div class="col-lg-12">
                            <label for="{{ form.notes.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-sticky text-hospital-primary"></i> Additional Notes
                            </label>
                            {{ form.notes }}
                            <div class="form-text">Any additional notes or instructions.</div>
                        </div>
                    </div>

                    <!-- Alternative Antibiotics Section -->
                    <div id="alternativesSection" class="mb-4 d-none">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-info-circle"></i> Suggested Alternatives
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="alternativesList"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between pt-3">
                        <a href="{% url 'doctor_dashboard' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Dashboard
                        </a>
                        <button type="submit" class="btn btn-hospital-primary btn-lg" id="submitBtn">
                            <i class="bi bi-check-circle"></i> Create Prescription
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Prescription Guidelines -->
        <div class="card mt-4">
            <div class="card-header bg-hospital-light-blue">
                <h6 class="mb-0 text-hospital-primary">
                    <i class="bi bi-info-circle"></i> Prescription Guidelines
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-shield-check text-success"></i> Best Practices</h6>
                        <ul class="small text-muted">
                            <li>Always check patient resistance history</li>
                            <li>Consider patient allergies before prescribing</li>
                            <li>Use appropriate dosage based on patient age/weight</li>
                            <li>Monitor patient response and adjust if needed</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-exclamation-triangle text-warning"></i> Important Notes</h6>
                        <ul class="small text-muted">
                            <li>Resistance alerts will appear automatically</li>
                            <li>Alternative antibiotics will be suggested</li>
                            <li>Patient feedback helps improve future prescribing</li>
                            <li>Follow local antibiotic stewardship guidelines</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const patientSelect = document.getElementById('id_patient');
    const antibioticSelect = document.getElementById('id_antibiotic');
    const resistanceAlert = document.getElementById('resistanceAlert');
    const resistanceMessage = document.getElementById('resistanceMessage');
    const alternativesSection = document.getElementById('alternativesSection');
    const alternativesList = document.getElementById('alternativesList');
    const submitBtn = document.getElementById('submitBtn');

    // Function to check resistance
    function checkResistance() {
        const patientId = patientSelect.value;
        const antibioticId = antibioticSelect.value;

        if (patientId && antibioticId) {
            // Show loading state
            resistanceAlert.classList.add('d-none');
            alternativesSection.classList.add('d-none');
            
            fetch(`/ajax/check-resistance/?patient_id=${patientId}&antibiotic_id=${antibioticId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.is_resistant) {
                        resistanceAlert.classList.remove('d-none');
                        resistanceMessage.innerHTML = data.message;
                        submitBtn.classList.add('btn-danger');
                        submitBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Create Prescription (Resistant)';
                        
                        // Get alternatives
                        getAlternatives(patientId, antibioticId);
                    } else {
                        resistanceAlert.classList.add('d-none');
                        alternativesSection.classList.add('d-none');
                        submitBtn.classList.remove('btn-danger');
                        submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Create Prescription';
                    }
                })
                .catch(error => {
                    console.error('Error checking resistance:', error);
                });
        } else {
            resistanceAlert.classList.add('d-none');
            alternativesSection.classList.add('d-none');
            submitBtn.classList.remove('btn-danger');
            submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Create Prescription';
        }
    }

    // Function to get alternatives
    function getAlternatives(patientId, antibioticId) {
        fetch(`/ajax/get-alternatives/?patient_id=${patientId}&antibiotic_id=${antibioticId}`)
            .then(response => response.json())
            .then(data => {
                if (data.alternatives && data.alternatives.length > 0) {
                    let alternativesHtml = '<div class="row">';
                    data.alternatives.forEach(alt => {
                        alternativesHtml += `
                            <div class="col-md-6 mb-3">
                                <div class="card border-info">
                                    <div class="card-body p-3">
                                        <h6 class="card-title mb-2 text-info">${alt.name}</h6>
                                        <p class="small text-muted mb-2">${alt.class_type}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="small">Targets: ${alt.bacteria_targeted}</span>
                                            <span class="badge bg-info">${alt.effectiveness_rate}% effective</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    alternativesHtml += '</div>';
                    alternativesList.innerHTML = alternativesHtml;
                    alternativesSection.classList.remove('d-none');
                } else {
                    alternativesSection.classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error getting alternatives:', error);
            });
    }

    // Event listeners
    patientSelect.addEventListener('change', checkResistance);
    antibioticSelect.addEventListener('change', checkResistance);

    // Initial check if both fields are already selected
    checkResistance();
});
</script>
{% endblock %}